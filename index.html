<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Web Browser</title>
    <style>
        /* --- Estilos Generales y Layout --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        /* --- Barra Lateral (Sidebar) --- */
        .sidebar {
            width: 350px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: left 0.3s ease;
        }

        .logo-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 15px;
            text-align: center;
            color: white;
            flex-shrink: 0;
        }

        .logo-header h1 {
            font-size: 18px;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .logo-header p {
            font-size: 11px;
            opacity: 0.9;
        }

        .proxy-controls {
            padding: 15px;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-input {
            width: 100%;
            padding: 8px 10px;
            background: #222;
            border: 1px solid #444;
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 12px;
        }

        .control-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }

        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-success { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ff416c, #ff4b2b); color: white; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-panel {
            padding: 15px;
            border-bottom: 1px solid #333;
            background: #1a1a1a;
            flex-shrink: 0;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .status-label { color: #888; }
        .status-value { color: #667eea; font-weight: bold; }

        .proxy-list-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .proxy-item {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 11px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .proxy-item:hover { background: #2a2a2a; }
        .proxy-item.active { border-color: #11998e; background: rgba(17, 153, 142, 0.1); }
        .proxy-item.working { border-left: 3px solid #11998e; }
        .proxy-item.failed { border-left: 3px solid #ff416c; opacity: 0.6; }

        .proxy-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .proxy-address { font-weight: bold; color: #e0e0e0; }
        .proxy-status { font-size: 10px; padding: 2px 6px; border-radius: 3px; text-transform: uppercase; }
        .status-working { background: rgba(17, 153, 142, 0.3); color: #11998e; }
        .status-failed { background: rgba(255, 65, 108, 0.3); color: #ff416c; }

        /* --- √Årea del Navegador --- */
        .browser-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #111;
        }

        /* --- Pesta√±as --- */
        .tabs-container {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 10px;
            min-height: 40px;
            flex-shrink: 0;
        }

        .tab {
            background: #222;
            border: 1px solid #333;
            border-bottom: none;
            padding: 8px 15px;
            margin-right: 2px;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-size: 12px;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            display: flex;
            align-items: center;
        }

        .tab.active {
            background: #333;
            border-color: #667eea;
            color: #fff;
        }
        
        .tab-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tab-close {
            margin-left: 8px;
            cursor: pointer;
            color: #888;
            font-weight: bold;
            padding: 2px;
        }

        .tab-close:hover { color: #ff416c; }

        .new-tab-btn {
            width: 30px;
            height: 30px;
            background: #222;
            border: 1px solid #444;
            border-radius: 3px;
            color: #e0e0e0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .new-tab-btn:hover { background: #333; }
        
        /* --- Barra de Marcadores --- */
        .bookmarks-bar {
            background: #1a1a1a;
            padding: 5px 15px;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            flex-shrink: 0;
        }

        .bookmark {
            padding: 5px 10px;
            background: #222;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .bookmark:hover {
            background: #333;
            border-color: #667eea;
        }

        /* --- Barra de Herramientas del Navegador --- */
        .browser-toolbar {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .nav-buttons { display: flex; gap: 5px; }

        .nav-btn {
            width: 35px;
            height: 35px;
            border: 1px solid #444;
            background: #222;
            color: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover { background: #333; border-color: #667eea; }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #444; }

        .address-bar {
            flex: 1;
            display: flex;
            background: #222;
            border: 1px solid #444;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .address-bar:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
        }

        .address-input {
            flex: 1;
            padding: 10px 15px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 14px;
        }

        .address-input:focus { outline: none; }

        .go-btn {
            padding: 0 15px;
            background: #667eea;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        .go-btn:hover { background: #5a6fd8; }

        .security-indicator { display: flex; align-items: center; gap: 10px; font-size: 12px; }
        .security-status { padding: 5px 10px; border-radius: 15px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .secure { background: rgba(17, 153, 142, 0.3); color: #11998e; }
        .insecure { background: rgba(255, 65, 108, 0.3); color: #ff416c; }

        /* --- Estad√≠sticas de Rendimiento --- */
        .performance-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 10px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        .perf-stat { text-align: center; padding: 8px; background: #222; border-radius: 5px; }
        .perf-number { font-size: 16px; font-weight: bold; color: #667eea; }
        .perf-label { font-size: 10px; color: #888; text-transform: uppercase; }

        /* --- Contenido del Navegador y Superposiciones --- */
        .browser-content {
            flex-grow: 1;
            background: #fff; /* Fondo blanco para el contenedor del iframe */
            position: relative;
            overflow: hidden;
        }
        
        .browser-content > div, .browser-content > iframe {
            width: 100%;
            height: 100%;
            overflow: auto;
            border: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none; /* Changed by JS */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            z-index: 1000;
        }
        
        .loading-overlay p {
            margin-top: 10px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Contenido de la P√°gina de Inicio --- */
        .homepage-content {
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .homepage-title { font-size: 36px; margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .homepage-subtitle { font-size: 18px; margin-bottom: 40px; opacity: 0.9; }

        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 800px;
            width: 100%;
        }

        .quick-link {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .quick-link:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }

        /* --- Consola --- */
        .console-panel {
            background: #0a0a0a;
            border-top: 1px solid #333;
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
            flex-shrink: 0;
        }

        .console-entry { margin-bottom: 2px; color: #888; }
        .console-entry.info { color: #667eea; }
        .console-entry.success { color: #11998e; }
        .console-entry.warning { color: #ffa726; }
        .console-entry.error { color: #ff416c; }

        /* --- Dise√±o Responsivo --- */
        .responsive-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 10000;
            background: #667eea;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            display: none; /* Hidden by default */
        }

        @media (max-width: 768px) {
            .responsive-toggle { display: block; }
            .sidebar { position: fixed; left: -350px; top: 0; height: 100vh; z-index: 9999; }
            .sidebar.mobile-open { left: 0; }
            .browser-area { width: 100%; }
            .performance-stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <button class="responsive-toggle" onclick="toggleSidebar()">‚ò∞</button>

    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <div class="logo-header">
                <h1>üõ°Ô∏è Anonymous Browser</h1>
                <p>Navegaci√≥n completamente an√≥nima</p>
            </div>

            <div class="proxy-controls">
                <div class="control-group">
                    <label class="control-label">Proxies por lote</label>
                    <input type="number" class="control-input" id="batchSize" value="30" min="10" max="100">
                </div>
                <div class="control-group">
                    <label class="control-label">Timeout (ms)</label>
                    <input type="number" class="control-input" id="timeout" value="3000" min="1000" max="10000">
                </div>
                <div class="control-group">
                    <label class="control-label">M√≠nimo funcionales</label>
                    <input type="number" class="control-input" id="minWorking" value="5" min="1" max="20">
                </div>
                <button class="btn btn-primary" id="startBtn" onclick="startProxyHunting()">
                    üöÄ Iniciar B√∫squeda
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopProxyHunting()" disabled>
                    ‚èπÔ∏è Detener
                </button>
            </div>

            <div class="status-panel">
                <div class="status-item">
                    <span class="status-label">Estado:</span>
                    <span class="status-value" id="huntingStatus">Inactivo</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Proxies Activos:</span>
                    <span class="status-value" id="activeProxies">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Proxy Actual:</span>
                    <span class="status-value" id="currentProxyDisplay">Ninguno</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Velocidad:</span>
                    <span class="status-value" id="proxySpeed">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">IP Oculta:</span>
                    <span class="status-value" id="ipHidden">‚ùå</span>
                </div>
            </div>

            <div class="proxy-list-container" id="proxyList">
                <div style="text-align: center; padding: 20px; color: #666;">
                    No hay proxies disponibles.<br>
                    Inicia la b√∫squeda arriba.
                </div>
            </div>
        </div>

        <div class="browser-area">
            <div class="tabs-container" id="tabsContainer">
                <!-- Las pesta√±as se generan din√°micamente aqu√≠ -->
            </div>

            <div class="bookmarks-bar">
                <div class="bookmark" onclick="navigateToUrl('https://httpbin.org/ip')">üîç Mi IP</div>
                <div class="bookmark" onclick="navigateToUrl('https://www.wikipedia.org')">üìö Wikipedia</div>
                <div class="bookmark" onclick="navigateToUrl('https://duckduckgo.com/')">ü¶Ü DuckDuckGo</div>
                <div class="bookmark" onclick="navigateToUrl('https://github.com')">üêô GitHub</div>
            </div>

            <div class="browser-toolbar">
                <div class="nav-buttons">
                    <button class="nav-btn" id="backBtn" onclick="goBack()" disabled>‚Üê</button>
                    <button class="nav-btn" id="forwardBtn" onclick="goForward()" disabled>‚Üí</button>
                    <button class="nav-btn" onclick="reloadPage()">‚Üª</button>
                    <button class="nav-btn" onclick="goHome()">üè†</button>
                </div>

                <div class="address-bar">
                    <input type="text" class="address-input" id="addressBar" 
                           placeholder="Ingresa URL o busca en DuckDuckGo..." 
                           onkeypress="handleAddressBarKeypress(event)">
                    <button class="go-btn" onclick="navigateFromAddressBar()">IR</button>
                </div>

                <div class="security-indicator">
                    <div class="security-status insecure" id="securityStatus">
                        <span id="securityIcon">‚ö†Ô∏è</span>
                        <span id="securityText">EXPUESTO</span>
                    </div>
                    <button class="nav-btn" onclick="toggleProxy()" title="Rotar Proxy">üîÑ</button>
                </div>
            </div>

            <div class="performance-stats">
                <div class="perf-stat">
                    <div class="perf-number" id="loadTime">-</div>
                    <div class="perf-label">Load Time</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-number" id="dataTransfer">-</div>
                    <div class="perf-label">Data Transfer</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-number" id="requests">-</div>
                    <div class="perf-label">Requests</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-number" id="proxyHops">-</div>
                    <div class="perf-label">Proxy Hops</div>
                </div>
            </div>

            <div class="browser-content" id="browserContent">
                 <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-spinner"></div>
                    <p id="loadingUrl">Cargando...</p>
                    <p id="loadingProxy">Conectando...</p>
                </div>
                <!-- El contenido (iframe o homepage) se carga aqu√≠ -->
            </div>

            <div class="console-panel" id="consolePanel"></div>
        </div>
    </div>

    <script>
        // =================================================================================
        // ANONYMOUS BROWSER - SCRIPT PRINCIPAL
        // VERSI√ìN FUNCIONAL CON IFRAME
        // =================================================================================

        // --- Estado Global de la Aplicaci√≥n ---
        let isHunting = false;
        let proxies = [];
        let workingProxies = [];
        let currentProxy = null;
        let currentTabIndex = 0;
        let tabs = [];
        let huntingInterval;
        let proxyRotationInterval;
        let nextTabId = 0;

        // --- Fuentes de Proxies (Simulaci√≥n) ---
        const proxySource = {
            public: [
                '103.140.112.170:8080', '185.162.231.106:80', '45.170.101.2:999',
                '194.5.193.183:80', '91.107.6.115:53281', '37.139.6.125:8080',
            ],
            ipRanges: [
                '103.{}.{}.{}', '185.{}.{}.{}', '45.{}.{}.{}', '194.{}.{}.{}',
                '91.{}.{}.{}', '37.{}.{}.{}', '78.{}.{}.{}', '188.{}.{}.{}'
            ],
            ports: [80, 8080, 3128, 8000, 8888, 9999, 8118, 1080]
        };
        
        // --- Elementos del DOM (Cache) ---
        const DOMElements = {
            sidebar: document.getElementById('sidebar'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            huntingStatus: document.getElementById('huntingStatus'),
            activeProxies: document.getElementById('activeProxies'),
            currentProxyDisplay: document.getElementById('currentProxyDisplay'),
            proxySpeed: document.getElementById('proxySpeed'),
            ipHidden: document.getElementById('ipHidden'),
            proxyList: document.getElementById('proxyList'),
            tabsContainer: document.getElementById('tabsContainer'),
            addressBar: document.getElementById('addressBar'),
            securityStatus: document.getElementById('securityStatus'),
            securityIcon: document.getElementById('securityIcon'),
            securityText: document.getElementById('securityText'),
            loadTime: document.getElementById('loadTime'),
            dataTransfer: document.getElementById('dataTransfer'),
            requests: document.getElementById('requests'),
            proxyHops: document.getElementById('proxyHops'),
            browserContent: document.getElementById('browserContent'),
            consolePanel: document.getElementById('consolePanel'),
            backBtn: document.getElementById('backBtn'),
            forwardBtn: document.getElementById('forwardBtn'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingUrl: document.getElementById('loadingUrl'),
            loadingProxy: document.getElementById('loadingProxy'),
        };

        // --- Funciones de Utilidad y Logging ---
        function addLog(message, type = 'info') {
            if (!DOMElements.consolePanel) return;
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `console-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            DOMElements.consolePanel.appendChild(entry);
            DOMElements.consolePanel.scrollTop = DOMElements.consolePanel.scrollHeight;
            if (DOMElements.consolePanel.children.length > 150) {
                DOMElements.consolePanel.removeChild(DOMElements.consolePanel.children[0]);
            }
        }

        // --- L√≥gica de B√∫squeda y Gesti√≥n de Proxies (Simulada) ---
        // (Esta parte no ha cambiado, sigue siendo una simulaci√≥n)
        function generateProxies(count) {
            const newProxies = [];
            proxySource.public.forEach(proxy => {
                const [ip, port] = proxy.split(':');
                newProxies.push({ ip, port: parseInt(port), type: 'http', status: 'untested', responseTime: null, source: 'public', lastTested: null });
            });
            const randomCount = Math.max(0, count - newProxies.length);
            for (let i = 0; i < randomCount; i++) {
                const pattern = proxySource.ipRanges[Math.floor(Math.random() * proxySource.ipRanges.length)];
                const ip = pattern.replace(/\{}/g, () => Math.floor(Math.random() * 255) + 1);
                const port = proxySource.ports[Math.floor(Math.random() * proxySource.ports.length)];
                newProxies.push({ ip, port, type: 'http', status: 'untested', responseTime: null, source: 'random', lastTested: null });
            }
            return newProxies;
        }
        async function testProxy(proxy) {
            return new Promise((resolve) => {
                const timeoutInput = document.getElementById('timeout');
                const timeout = timeoutInput ? parseInt(timeoutInput.value) : 3000;
                const startTime = Date.now();
                setTimeout(() => {
                    const isWorking = Math.random() > 0.8;
                    const responseTime = Date.now() - startTime;
                    proxy.status = isWorking ? 'working' : 'failed';
                    proxy.responseTime = isWorking ? responseTime + Math.random() * 500 : null;
                    proxy.lastTested = new Date();
                    if (isWorking) {
                        workingProxies.push(proxy);
                        addLog(`‚úÖ Proxy funcional: ${proxy.ip}:${proxy.port} (${proxy.responseTime.toFixed(0)}ms)`, 'success');
                    }
                    resolve(proxy);
                }, Math.random() * timeout * 0.8 + timeout * 0.2);
            });
        }
        async function testProxiesBatch(proxiesBatch) {
            addLog(`üîç Probando lote de ${proxiesBatch.length} proxies...`, 'info');
            await Promise.all(proxiesBatch.map(p => testProxy(p)));
            updateProxyDisplay();
            updateStatus();
        }
        async function startProxyHunting() {
            if (isHunting) return;
            isHunting = true;
            if (DOMElements.startBtn) DOMElements.startBtn.disabled = true;
            if (DOMElements.stopBtn) DOMElements.stopBtn.disabled = false;
            addLog('üöÄ Iniciando b√∫squeda autom√°tica de proxies...', 'success');
            await proxyHuntingCycle();
            proxyRotationInterval = setInterval(() => { if (workingProxies.length > 0) rotateToNextProxy(); }, 45000);
            huntingInterval = setInterval(proxyHuntingCycle, 60000);
        }
        function stopProxyHunting() {
            if (!isHunting) return;
            isHunting = false;
            clearInterval(huntingInterval);
            clearInterval(proxyRotationInterval);
            if (DOMElements.startBtn) DOMElements.startBtn.disabled = false;
            if (DOMElements.stopBtn) DOMElements.stopBtn.disabled = true;
            updateStatus();
            addLog('‚èπÔ∏è B√∫squeda de proxies detenida', 'warning');
        }
        async function proxyHuntingCycle() {
            if (!isHunting) return;
            const batchSizeInput = document.getElementById('batchSize');
            const batchSize = batchSizeInput ? parseInt(batchSizeInput.value) : 30;
            const newProxies = generateProxies(batchSize);
            proxies.push(...newProxies);
            addLog(`üì• Generados ${newProxies.length} proxies nuevos`, 'info');
            const chunkSize = 10;
            for (let i = 0; i < newProxies.length; i += chunkSize) {
                if (!isHunting) break;
                await testProxiesBatch(newProxies.slice(i, i + chunkSize));
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            if (!currentProxy && workingProxies.length > 0) selectBestProxy();
            if (proxies.length > 200) proxies = proxies.slice(-100);
            addLog(`üìä Estado: ${workingProxies.length} proxies funcionales`, 'info');
        }
        function selectProxy(ip, port) {
            const proxy = proxies.find(p => p.ip === ip && p.port === port);
            if (!proxy || proxy.status !== 'working') {
                addLog(`‚ùå No se puede seleccionar proxy no funcional ${ip}:${port}`, 'error');
                return;
            }
            currentProxy = proxy;
            updateStatus();
            updateProxyDisplay();
            updateSecurityStatus();
            addLog(`‚úÖ Proxy seleccionado: ${ip}:${port} (${proxy.responseTime?.toFixed(0)}ms)`, 'success');
        }
        function selectBestProxy() {
            if (workingProxies.length === 0) return;
            const bestProxy = workingProxies.sort((a, b) => a.responseTime - b.responseTime)[0];
            selectProxy(bestProxy.ip, bestProxy.port);
        }
        function rotateToNextProxy() {
            if (workingProxies.length <= 1) return;
            const currentIndex = workingProxies.findIndex(p => currentProxy && p.ip === currentProxy.ip && p.port === currentProxy.port);
            const nextIndex = (currentIndex + 1) % workingProxies.length;
            selectProxy(workingProxies[nextIndex].ip, workingProxies[nextIndex].port);
            addLog(`üîÑ Proxy rotado autom√°ticamente`, 'info');
        }
        function toggleProxy() {
            if (workingProxies.length > 0) rotateToNextProxy();
            else addLog('‚ö†Ô∏è No hay proxies funcionales para rotar', 'warning');
        }

        // --- L√≥gica de Pesta√±as (Tabs) ---
        function newTab(url = 'home', title = 'üè† Inicio') {
            const tabId = nextTabId++;
            const newTab = { id: tabId, url, title, history: url === 'home' ? [] : [url], historyIndex: url === 'home' ? -1 : 0 };
            tabs.push(newTab);
            createTabElement(newTab);
            switchTab(tabId);
            return newTab;
        }
        function createTabElement(tabData) {
            const tabElement = document.createElement('div');
            tabElement.className = 'tab';
            tabElement.dataset.tabId = tabData.id;
            tabElement.innerHTML = `<span class="tab-title">${tabData.title}</span><span class="tab-close">√ó</span>`;
            tabElement.addEventListener('click', (e) => {
                if (e.target.className !== 'tab-close') switchTab(tabData.id);
            });
            tabElement.querySelector('.tab-close').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(tabData.id);
            });
            if (DOMElements.tabsContainer) {
                const newTabBtn = DOMElements.tabsContainer.querySelector('.new-tab-btn');
                DOMElements.tabsContainer.insertBefore(tabElement, newTabBtn);
            }
        }
        function closeTab(tabId) {
            if (tabs.length <= 1) {
                addLog("‚ùå No se puede cerrar la √∫ltima pesta√±a.", "error");
                return;
            }
            const tabIndex = tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;
            tabs.splice(tabIndex, 1);
            const tabElement = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
            if (tabElement) tabElement.remove();
            if (currentTabIndex === tabId) {
                const newActiveTab = tabs[tabIndex] || tabs[tabIndex - 1];
                switchTab(newActiveTab.id);
            }
        }
        function switchTab(tabId) {
            currentTabIndex = tabId;
            document.querySelectorAll('.tab').forEach(tabEl => {
                tabEl.classList.toggle('active', tabEl.dataset.tabId == tabId);
            });
            updateUIForCurrentTab();
        }
        function updateTabTitle(title) {
            const tabData = tabs.find(t => t.id === currentTabIndex);
            const tabElement = document.querySelector(`.tab[data-tab-id="${currentTabIndex}"] .tab-title`);
            if (tabData && tabElement) {
                tabData.title = title;
                tabElement.textContent = title;
            }
        }

        // --- L√≥gica de Navegaci√≥n ---
        function navigateToUrl(url, fromHistory = false) {
            if (!url) return;
            if (!url.includes('.') && !url.startsWith('http')) {
                // Usar DuckDuckGo para b√∫squedas, ya que permite ser iframed
                url = `https://duckduckgo.com/?q=${encodeURIComponent(url)}`;
            }
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            const currentTab = tabs.find(t => t.id === currentTabIndex);
            if (!currentTab) return;
            if (DOMElements.addressBar) DOMElements.addressBar.value = url;
            if (!fromHistory) addToHistory(url);
            currentTab.url = url;
            let title = url.replace(/^https?:\/\//, '').split('/')[0];
            updateTabTitle(title.length > 20 ? title.substring(0, 20) + '...' : title);
            
            showLoadingOverlay(url);
            updateUIForCurrentTab();
        }
        function navigateFromAddressBar() {
            if (DOMElements.addressBar) navigateToUrl(DOMElements.addressBar.value.trim());
        }
        function handleAddressBarKeypress(event) {
            if (event.key === 'Enter') navigateFromAddressBar();
        }
        function addToHistory(url) {
            const tab = tabs.find(t => t.id === currentTabIndex);
            if (!tab) return;
            if (tab.historyIndex < tab.history.length - 1) {
                tab.history = tab.history.slice(0, tab.historyIndex + 1);
            }
            tab.history.push(url);
            tab.historyIndex = tab.history.length - 1;
            updateNavButtons();
        }
        function goBack() {
            const tab = tabs.find(t => t.id === currentTabIndex);
            if (tab && tab.historyIndex > 0) {
                tab.historyIndex--;
                navigateToUrl(tab.history[tab.historyIndex], true);
            }
        }
        function goForward() {
            const tab = tabs.find(t => t.id === currentTabIndex);
            if (tab && tab.historyIndex < tab.history.length - 1) {
                tab.historyIndex++;
                navigateToUrl(tab.history[tab.historyIndex], true);
            }
        }
        function reloadPage() {
            const tab = tabs.find(t => t.id === currentTabIndex);
            if (tab) {
                const contentFrame = DOMElements.browserContent.querySelector('iframe');
                if (contentFrame) {
                    contentFrame.src = tab.url;
                } else {
                    updateUIForCurrentTab();
                }
            }
        }
        function goHome() {
            const tab = tabs.find(t => t.id === currentTabIndex);
            if (tab) {
                tab.url = 'home';
                updateUIForCurrentTab();
            }
        }
        
        // --- Actualizaci√≥n de la Interfaz (UI) ---
        function updateStatus() {
            if (DOMElements.activeProxies) DOMElements.activeProxies.textContent = workingProxies.length;
            if (DOMElements.huntingStatus) DOMElements.huntingStatus.textContent = isHunting ? 'Buscando...' : 'Inactivo';
            if (currentProxy) {
                if(DOMElements.currentProxyDisplay) DOMElements.currentProxyDisplay.textContent = `${currentProxy.ip}:${currentProxy.port}`;
                if(DOMElements.proxySpeed) DOMElements.proxySpeed.textContent = `${currentProxy.responseTime?.toFixed(0) || '-'}ms`;
                if(DOMElements.ipHidden) DOMElements.ipHidden.textContent = '‚úÖ';
            } else {
                if(DOMElements.currentProxyDisplay) DOMElements.currentProxyDisplay.textContent = 'Ninguno';
                if(DOMElements.proxySpeed) DOMElements.proxySpeed.textContent = '-';
                if(DOMElements.ipHidden) DOMElements.ipHidden.textContent = '‚ùå';
            }
        }
        function updateProxyDisplay() {
            if (!DOMElements.proxyList) return;
            const sortedProxies = [...workingProxies, ...proxies.filter(p => p.status !== 'working')].sort((a, b) => {
                if (a.status === 'working' && b.status !== 'working') return -1;
                if (a.status !== 'working' && b.status === 'working') return 1;
                if (a.status === 'working' && b.status === 'working') return a.responseTime - b.responseTime;
                return 0;
            });
            DOMElements.proxyList.innerHTML = '';
            sortedProxies.slice(0, 50).forEach(proxy => {
                const isActive = currentProxy && currentProxy.ip === proxy.ip && currentProxy.port === proxy.port;
                const item = document.createElement('div');
                item.className = `proxy-item ${proxy.status} ${isActive ? 'active' : ''}`;
                item.innerHTML = `<div class="proxy-header"><div class="proxy-address">${proxy.ip}:${proxy.port}</div><div class="proxy-status status-${proxy.status}">${proxy.status}</div></div><div style="color: #888; font-size: 10px;">${proxy.responseTime ? `‚ö° ${proxy.responseTime.toFixed(0)}ms` : ''} ${proxy.source ? `üìç ${proxy.source}` : ''} ${proxy.lastTested ? `üïí ${proxy.lastTested.toLocaleTimeString()}` : ''}</div>`;
                if (proxy.status === 'working') item.onclick = () => selectProxy(proxy.ip, proxy.port);
                DOMElements.proxyList.appendChild(item);
            });
        }
        function updateSecurityStatus() {
            if (!DOMElements.securityStatus || !DOMElements.securityIcon || !DOMElements.securityText) return;
            if (currentProxy) {
                DOMElements.securityStatus.className = 'security-status secure';
                DOMElements.securityIcon.textContent = 'üõ°Ô∏è';
                DOMElements.securityText.textContent = 'AN√ìNIMO';
            } else {
                DOMElements.securityStatus.className = 'security-status insecure';
                DOMElements.securityIcon.textContent = '‚ö†Ô∏è';
                DOMElements.securityText.textContent = 'EXPUESTO';
            }
        }
        function updateNavButtons() {
            const tab = tabs.find(t => t.id === currentTabIndex);
            if (tab && DOMElements.backBtn && DOMElements.forwardBtn) {
                DOMElements.backBtn.disabled = tab.historyIndex <= 0;
                DOMElements.forwardBtn.disabled = tab.historyIndex >= tab.history.length - 1;
            }
        }
        function updateUIForCurrentTab() {
            const tab = tabs.find(t => t.id === currentTabIndex);
            if (!tab) return;
            if (DOMElements.addressBar) DOMElements.addressBar.value = tab.url === 'home' ? '' : tab.url;
            if (tab.url === 'home') {
                showHomepageContent();
            } else {
                showIframeContent(tab.url);
            }
            updateNavButtons();
        }
        function showLoadingOverlay(url) {
            if(DOMElements.loadingOverlay) {
                DOMElements.loadingUrl.textContent = `Cargando ${url}...`;
                DOMElements.loadingProxy.textContent = currentProxy ? `A trav√©s de ${currentProxy.ip}:${currentProxy.port}...` : 'Conectando directamente...';
                DOMElements.loadingOverlay.style.display = 'flex';
            }
        }
        function hideLoadingOverlay() {
            if (DOMElements.loadingOverlay) DOMElements.loadingOverlay.style.display = 'none';
        }
        function showHomepageContent() {
            if (!DOMElements.browserContent) return;
            DOMElements.browserContent.innerHTML = `
                <div class="homepage-content">
                    <h1 class="homepage-title">üõ°Ô∏è Anonymous Browser</h1>
                    <p class="homepage-subtitle">Navega de forma an√≥nima y segura</p>
                    <div class="quick-links">
                        <div class="quick-link" onclick="navigateToUrl('https://httpbin.org/ip')"><h3>üîç Verificar IP</h3><p>Comprueba tu IP actual</p></div>
                        <div class="quick-link" onclick="navigateToUrl('https://www.wikipedia.org')"><h3>üìö Wikipedia</h3><p>La enciclopedia libre</p></div>
                        <div class="quick-link" onclick="navigateToUrl('https://duckduckgo.com')"><h3>ü¶Ü DuckDuckGo</h3><p>B√∫squeda privada</p></div>
                    </div>
                </div>`;
            hideLoadingOverlay();
        }
        function showIframeContent(url) {
            if (!DOMElements.browserContent) return;
            DOMElements.browserContent.innerHTML = ''; // Limpiar contenido anterior
            DOMElements.browserContent.appendChild(DOMElements.loadingOverlay); // Re-adjuntar el overlay

            const iframe = document.createElement('iframe');
            iframe.src = url;
            // Sandbox para seguridad, permite scripts y formularios pero aisla el contenido
            iframe.setAttribute('sandbox', 'allow-forms allow-modals allow-pointer-lock allow-popups allow-same-origin allow-scripts');
            iframe.setAttribute('referrerpolicy', 'no-referrer');
            
            iframe.onload = () => {
                addLog(`‚úÖ URL cargada: ${url}`, 'success');
                hideLoadingOverlay();
            };
            iframe.onerror = () => {
                addLog(`‚ùå No se pudo cargar la URL: ${url}. El sitio puede bloquear la carga en iframes.`, 'error');
                hideLoadingOverlay();
            };
            
            DOMElements.browserContent.appendChild(iframe);
        }
        function toggleSidebar() {
            if (DOMElements.sidebar) DOMElements.sidebar.classList.toggle('mobile-open');
        }

        // --- Inicializaci√≥n de la Aplicaci√≥n ---
        function initialize() {
            const savedConfig = localStorage.getItem('anonymousBrowserConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                Object.entries(config).forEach(([key, value]) => {
                    const element = document.getElementById(key);
                    if (element) element.value = value;
                });
            }
            ['batchSize', 'timeout', 'minWorking'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', () => {
                    localStorage.setItem('anonymousBrowserConfig', JSON.stringify({
                        batchSize: document.getElementById('batchSize').value,
                        timeout: document.getElementById('timeout').value,
                        minWorking: document.getElementById('minWorking').value
                    }));
                });
            });
            const newTabButton = document.createElement('div');
            newTabButton.className = 'new-tab-btn';
            newTabButton.textContent = '+';
            newTabButton.onclick = () => newTab();
            if(DOMElements.tabsContainer) DOMElements.tabsContainer.appendChild(newTabButton);
            
            newTab(); // Crear la primera pesta√±a
            
            addLog('üõ°Ô∏è Anonymous Browser iniciado', 'success');
            addLog('‚ÑπÔ∏è Introduce una URL o busca para empezar.', 'info');
        }

        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
